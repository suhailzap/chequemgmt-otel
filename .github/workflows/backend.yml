name: Backend CI/CD

on:
  push:
    paths:
      - 'chequemgmt/backend/**'
  workflow_dispatch:

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/chequebackend

jobs:
  build-backend:
    name: Build, Test, Scan & Push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          # 1. MAVEN CACHE: This caches ~/.m2/repository based on pom.xml hash
          cache: maven

      - name: Build & Test
        run: |
          cd chequemgmt/backend
          mvn clean test package

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 2. DOCKER CACHE (BUILD): Uses the GHA cache backend
      - name: Build Image for Scanning
        uses: docker/build-push-action@v5
        with:
          context: chequemgmt/backend
          load: true 
          tags: ${{ env.DOCKER_IMAGE }}:test-scan
          # Pulls cache from GitHub Actions cache
          cache-from: type=gha
          # Writes cache to GitHub Actions cache (mode=max saves all layers)
          cache-to: type=gha,mode=max

      - name: Scan Docker Image (Trivy)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:test-scan
          format: table
          exit-code: 1 
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      # 3. DOCKER CACHE (PUSH): Reuse the cache from the previous step
      - name: Build and Push Multi-Arch Image
        uses: docker/build-push-action@v5
        with:
          context: chequemgmt/backend
          platforms: linux/amd64,linux/arm64
          push: true
          # Reuses the cache created in the "Build Image for Scanning" step
          cache-from: type=gha
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}





# name: Backend CI/CD

# on:
#   push:
#     paths:
#       - 'chequemgmt/backend/**'
#   workflow_dispatch:

# env:
#   DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
#   DOCKER_IMAGE: ${{ secrets.DOCKER_HUB_USERNAME }}/chequebackend

# jobs:
#   build-backend:
#     name: Build, Test, Scan & Push
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Java 21
#         uses: actions/setup-java@v4
#         with:
#           java-version: '21'
#           distribution: 'temurin'
#           cache: maven

#       - name: Build & Test
#         run: |
#           cd chequemgmt/backend
#           mvn clean test package # This ensures both tests pass and JAR is created

#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: Docker Login
#         uses: docker/login-action@v3
#         with:
#           username: ${{ env.DOCKER_HUB_USERNAME }}
#           password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

#       # Build and export to Docker for local scanning (before pushing)
#       - name: Build Image for Scanning
#         uses: docker/build-push-action@v5
#         with:
#           context: chequemgmt/backend
#           load: true # Loads into local docker images
#           tags: ${{ env.DOCKER_IMAGE }}:test-scan

#       - name: Scan Docker Image (Trivy)
#         uses: aquasecurity/trivy-action@0.28.0
#         with:
#           image-ref: ${{ env.DOCKER_IMAGE }}:test-scan
#           format: table
#           exit-code: 1 # Fails the pipeline if vulnerabilities are found
#           severity: 'CRITICAL,HIGH'
#           ignore-unfixed: true

#       # If scan passes, Build and Push multi-arch
#       - name: Build and Push Multi-Arch Image
#         uses: docker/build-push-action@v5
#         with:
#           context: chequemgmt/backend
#           platforms: linux/amd64,linux/arm64
#           push: true
#           tags: |
#             ${{ env.DOCKER_IMAGE }}:latest
#             ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
